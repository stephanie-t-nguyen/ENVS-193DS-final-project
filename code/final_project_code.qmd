---
title: "Final Project Code"
author: "Kyle Cahitas, Stephanie Nguyen, William Yip"
date: "June 9, 2023"
format:
  html:
    toc: true
    toc-location: left
    code-fold: true
    theme: yeti
editor: visual
execute:
  message: false
  warning: false
bibliography: references.bib
---

### Notes \[DELETE LATER\]

Problem #1: How does total seed number differ between kangaroo rat mound locations?

Summary of context article (The Composition of seed banks) Rat mound creates micro-environments that can effect seed banks or number of seeds, studies tend to show that there are more seeds around mounds

-   probably do a single linear regression like in homework 4? Have to use Kruskel test instead of ANOVA because data is non-normal

Data Dictionary:

-   mnd: kangaroo rat mound (location)

-   dir: direction from center of the mound

-   loc: microhabitat (B = base, S = surrounding, E = edge, I = interspace)

-   species: four letter code for target taxa

-   seeds: seed counts for species and percent cover for physical variables

Problem #2: How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?

-   probably do a multiple linear regression like in homework 5? --actually we CAN"T because the data is not normal

Summary: Because of climate change "shrubfication is happening in the tundra, where more shrubs are growing in the tundra, which would effect the ecosystem there. On average, there are more flowers in open plots vs shrub plots. Shrub plots are plots that have undergone shrubfication. Open plots have not experienced shrubfication yet.

Data Table/Dictionary

pollinator: observations of pollinators visiting plots

-   shrub_num: shrub ID

-   treatment: open or shrub plot

-   pollinator_ID: what type of pollinator

-   cloud_cover: "rough % cloud cover" - whatever that means

-   wind: wind speed (mph) - probably because it affects pollinators

seed_ctwt

-   species_ID: what plant

-   plant_nr: plant number, what number 1-5 plant was assigned to

-   total_nr_infl: total number of inflorescenses

-   nr_infl_coll: number of inforesecenses collected

-   nr_seeds: seed numbers

-   wt_seeds_mg: seed weights

individual_flower

community_flower

Siting data:

-   problem one data: [@koontz2013]

-   problem one context: [@koontz2010]

-   problem two data: [@seaver2022]

# Introduction

Kangaroo rats build mounds that create micro-environments and foster more plant diversity than adjacent grassland [@guo1996]. Even within the same mound, there are different microhabitats depending on distance away from the mound [@koontz2010]. Using data from "Effects of Kangaroo Rat Mounds," our study investigates how total seed number differs between kangaroo rat mound locations (base of the mound, surrounding areas, edge of mound, and interspace between mound and grassland) [@koontz2013]. Our null hypothesis states that there is no difference in number of seeds between the different kangaroo rat mound locations. Our alternative hypothesis states that some locations of the mound support more seeds than others.

### Set Up

```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(here)
library(naniar)
library(tidyverse)
library(GGally)
library(tidyr)
library(corrplot)
library(skimr)
library(stringr)
library(effsize)
library(rstatix)
library(flextable)
library(performance)
library(base)
```

```{r}
#Load in Problem 1 data
kangaroo_rat <- here("data", "sev208_kratseedbank_20120213.txt") |> #File path
  read.csv(header= TRUE, sep =",", quote = "") |> #Has header, delimiter is comma, no quoting
  mutate(loc = str_replace_all(loc, c("B" = "Base", #Replace code names with actual names
                                      "D" = "Surrounding",
                                      "E" = "Edge",
                                      "I" = "Interspace"))) |> 
  mutate(seeds = as.numeric(seeds)) #Make sure data is numeric
  
  
#Load in Problem 2 data
pollinator <- here("data", "shrubstudy_pollinator.ms.data.csv") |> 
  read.csv()

seed_ctwt <- here("data", "shrubstudy_seed_ctwt.ms.data.csv") |> 
  read.csv()

individual_flower <- here("data", "shrubstudy_individual_flower_counts.ms.data.csv") |> 
  read.csv()

community_flower <- here("data", "shrubstudy_community_flower_counts.ms.data.csv") |> 
  read.csv()
```

# Methods Problem #1

The data was collected by...

The data was cleaned by...(Figure 1) no missing data

An exploratory data visualization was creating plotting the number of seeds at each of the four mound locations (Figure 2). At a glance, it appears that the closer the location to the mound, the more seeds tended to be observed there, however, many observations tended to cluster at zero.

To further investigate, the data was visually (Figure 3) and statistically checked for homoscedasticity and normality. According to the checks, the data was both heteroscedastic and non-normal.

Thus, a Kruskel-Wallis test was run. The Kruskel-Wallis test ......

The effect size indicates that the difference in seed counts between mound locations is significant but small.

```{r}
#Missing data check
gg_miss_var(kangaroo_rat) #No data missing
```

**Figure 1.** Visualization of Missing Data in "kangaroo_rat" dataframe

The y-axis are the variables (columns in the dataframe and the x-axis marks how many rows have missing data per variable.

```{r}
kangaroo_rat_subset <- kangaroo_rat |> 
  filter(!grepl("soil|gravel|dist|litter|plant", species)) |>  #Filter out irrevelant columns (physical descriptors)
  group_by(mnd, dir, loc) |> #Group to get total seeds per mound location
  summarize(total_seeds = sum(seeds)) |>
  ungroup()
```

```{r}
#Exploratory data visualization, looks like locations closet to mound have most seeds, but we should further explore
ggplot() + 
  geom_boxplot(data = kangaroo_rat_subset, aes(x = loc, y = total_seeds, color = loc)) +
  geom_jitter(data = kangaroo_rat_subset, aes(x = loc, y = total_seeds, color = loc), alpha = 0.4) + #Create jitter plot of seed count observations 
  theme_bw() + #Set theme
  theme(legend.position = "none") + #Omit legend
  labs(x = "Mound Location", #Label axes
       y = "Number of Seeds") + 
  scale_x_discrete(limits = c("Base", "Surrounding", "Edge", "Interspace")) #Reorder locations from closet to furthest
  
```

**Figure 2.** Exploratory Data Visualization of Seeds vs Mound Location

This figure plots observations of the number of seeds found at each mound location. The locations are in order from closet to furthest from the mound, from the base of the mound to the interspace adjacent to the grassland.

```{r}
#Create model to further explore relationship
modelobject <- lm(total_seeds ~ loc, data = kangaroo_rat_subset)

#Visualize models - diagnostic plots in a grid 
par(mfrow = c(2, 2))
plot(modelobject) #Data is not normal 
```

**Figure 3.** Diagnostic Plots for Kangaroo Rat Data

The Residual vs Fitted plot checks for constant variance (homoscedasticity) among the residuals. The Scale-Location plot also checks for homoscedasticity, but using the square root of the residuals; both plots show a change in pattern, where points decrease in density from bottom to top, suggesting heteroscedasticity. The Normal Q-Q plot suggests non-normality because of the deviation from the dotted line at the right tail end of the data. The Constant Leverage plot shows outliers in the data, but there do not appear to be any.

```{r}
#Statistical checks
kr_model <- lm(total_seeds ~ loc, data = kangaroo_rat_subset)
check_normality(kr_model) #The data is not normal
check_heteroscedasticity(kr_model) #The data is heteroscedastic
```

```{r}
kruskal_results <- kruskal.test(total_seeds ~ loc, data = kangaroo_rat_subset) #p-value very small, evidence to reject the null, evidence that there is a difference in seed numbers among the mound locations
kruskal_results 
```

```{r}
#Post-hoc tests to see how and which ranks differ
rstatix::kruskal_effsize(total_seeds ~ loc, data = kangaroo_rat_subset, conf.level = 0.95) |> 
  flextable() |> #Make data frame into a flex table object
  set_header_labels(.y. = "Dependent Variable", #Change header labels to be meaningful 
                    n = "Number of Observations", 
                    effsize = "Effect Size",
                    method = "Method",
                    magnitude = "Magnitude")

#Magnitude is very small, so the difference between seed number at different locations is significant but small
```

**Figure 4.** Effect Size of Kruskal Wallis Test

The table shows the results of calculating the effect size of the Kruskal Wallis Test.

# Results Problem #1

-   low p-value suggests evidence to reject null hypothesis, difference in medians among locations

# Introduction Problem #2

The Niwot Ridge is an alpine ecosystem that consists of cold, snowy, and windy climates and low temperatures during the growing season (Edwards et al., 2007). Despite these conditions, many plants have adapted to this environment.Â  Learning more about these plants can better inform us of plants that live in their climate limits (Germino, 2014). Seed count is the number of seeds produced by a plant that is commonly used to determine the plant\'s fitness (Wen and Simmons, 2020). Plants have numerous biological and physical factors that can contribute to their seed count. Using data from \"Individual and community flowering phenology, seed counts and pollinator visitation rates in shrub and open plots across Niwot Ridge, 2019 - 2021\", we will investigate how the seed count of plants in the Niwot Ridge varies with total number of inflorescences, plant species, and plot type. We hypothesize that plant species and number of inflorescences will be the biggest factors in determining seed count.

# Methods Problem #2

There were four datasets the study that they came from, but we only used one of them called seed count weight. We did this because seed count weight contained all of the variables that we were using to compare seed count such as total number of inflorescence, plant species, and plot type. Seaver counted the number of seeds by breaking up dried buds with her fingers and counting all the viable seeds. A seed was \"viable\" if it had a plump look and feel compared to an aborted seed that was clearly shriveled and small. The seeds were collected from five different species: Geuros, Kobmyo, Carrup, Arefen, and Minobt. Viable seeds were recorded and put into envelopes that had their respective species, plot number, and number of inflorescences collected (Seaver, 2022).

```{r}
gg_miss_var(pollinator) #Most of tag_num missing
gg_miss_var(seed_ctwt) #Most of dist_fr_shr, wt_seeds_mg, nr_seeds missing
gg_miss_var(individual_flower) #dist_fr_shr missing, some flower count missing
gg_miss_var(community_flower) #No missing data
```

```{r}
#Clean data
seed_ctwt_subset <- seed_ctwt |> 
  select(c("treatment", "species", "total_nr_infl", "nr_seeds")) |> #Plot type, plant species, total number of inflorescences - select relevant columns 
  drop_na(nr_seeds) #Thats a lot of data missing... should we do anything? 

#Not quite sure what the total number of inflorescences vs inflorescence collected means
```

```{r}
#Delete this? 

#Calculate Pearson's r for numerical values only 
seed_cor <- seed_ctwt_subset |> 
  dplyr::select(total_nr_infl:nr_seeds) |> #Not sure if this is correct
  cor(method = "pearson")

#Create correlation plot
corrplot(seed_cor, 
         method = "ellipse", #Change shape of item in cells
         addCoef.col = "black") #Add coefficient in black text
```

```{r}
seed_ctwt_subset |> 
  dplyr::select(total_nr_infl:nr_seeds) |> #Not sure if this is correct either
  ggpairs()
```

```{r}
#Create a null and a full model - fit multiple linear models in order to see which one is best
null <- lm(nr_seeds ~ 1, data = seed_ctwt_subset)
#Assume no relationship between total mass and predictor variables 
#1 indicates absence of all other predictors 

full <- lm(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset)
#Assume predictor variables can predict biomass
```

```{r}
par(mfrow = c(2, 2))
plot(full) #DATA IS NOT NORMAL CANNOT DO MULTIPLE LINEAR REGRESSION 
```

# yes

## From

```{r set-up}
library(tidyverse)
library(here)
library(janitor)
library(ggeffects)
library(performance)
library(naniar)
library(flextable)
library(car)
library(broom)
library(AICcmodavg)
library(GGally)
library(MuMIn)
#######

library(DHARMa)
library(MASS)
library(lme4)
library(glmmTMB)
#install.packages('TMB', type = 'source')
```

```{r}
skim(seed_ctwt_subset)
```

```{r}
# linear model, we know this is wrong
seed_L1 <- lm(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset)

# generalized linear model with Poisson distribution
seedctwt2 <-glm(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset, family = "poisson")
seedctwt2.a <- glm(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset, family = "poisson")

# generalized linear model with negative binomial distribution
seedctwt3 <- glm.nb(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset)
seedctwt3.a <- glmmTMB(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset, family = "nbinom2")

# generalized linear model with Poisson distribution and random effect of site
#seedctwt4 <- glmer(nr_seeds ~ treatment + species + total_nr_infl, data = seed_ctwt_subset, family = "poisson") 
# need to go over this model, as in class it was site, but IDK how to do incorperate it into our dataframe 

##from Class###
# generalized linear model with Poisson distribution and random effect of site
#salmod4 <- glmer(count ~ cover + mined  + spp + (1|site), data = salamanders, family = "poisson")
#salmod4.a <- glmmTMB(count ~ cover + mined  + spp + (1|site), data = salamanders, family = "poisson")

```

```{r}
# linear model vibe
plot(simulateResiduals(seed_L1, plot = TRUE))
```

```{r}
# generalized linear model with Poisson distribution
plot(simulateResiduals(seedctwt2, plot = TRUE))
```

```{r}
# generalized linear model with negative binomial distribution
plot(simulateResiduals(seedctwt3, plot = TRUE))
```

How does seed count vary with plot type (shrub or open), plant species, and total number of inflorescences? Is there a simpler model that explains seed count, and if so, what is it?

# Results Problem #2

# References
